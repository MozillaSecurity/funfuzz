dist: trusty
sudo: required  # has ~2x RAM: https://docs.travis-ci.com/user/reference/overview/#Virtualization-environments
language: python
matrix:
    fast_finish: true
    include:
        - python: "2.7"
        - python: "3.5"
        - python: "3.6"
        - python: "3.7-dev"
        - python: "nightly"
    allow_failures:
        - python: "3.5"
        - python: "3.6"
        - python: "3.7-dev"
        - python: "nightly"
addons:
    apt:
        sources:
            - ubuntu-toolchain-r-test
        packages:
            - autoconf2.13
            - cargo
            - g++-5
            - g++-5-multilib
            - gcc-5
            - gcc-5-multilib
            - gdb
            - lib32z1  # needed by 32-bit builds
            - libc6-dbg  # needed by Valgrind
            - valgrind
before_install:
    # Use GCC 5
    - mkdir -p latest-gcc-symlinks  # See https://github.com/travis-ci/travis-ci/issues/3668#issuecomment-279276549
    - ln -s /usr/bin/g++-5 latest-gcc-symlinks/g++
    - ln -s /usr/bin/gcc-5 latest-gcc-symlinks/gcc
    - export PATH=$PWD/latest-gcc-symlinks:$PATH
install:
    - pip install --upgrade codecov pytest-cov pytest-flake8 pytest-pylint  # Already in venv, no need for --user
    - pip install --upgrade -e .
    - gcc --version
    - g++ --version
    - hg --version
script:
    - python -m pytest
after_success:
    - codecov
